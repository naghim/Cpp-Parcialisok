#include "malwarecatalog.h"
#include <iostream>
#include <fstream>
#include <string>
#include <sstream>
#include "virus.h"
#include "ransomware.h"
#include "worm.h"

int main()
{
	MalwareCatalog catalog;

	std::ifstream file("catalog.txt");
	if (!file.is_open())
	{
		std::cerr << "Error opening the file." << std::endl;
		return 1;
	}

	std::string line;
	while (std::getline(file, line))
	{
		if (line.empty())
			continue;

		// első sor: Típus Név+Év+Veszélyességi szint
		std::stringstream ss(line);
		char type;
		std::string name, yearStr, threatStr;

		ss >> type;
		// típus után van space, ezt levágjuk beolvasáskor a ss >> std::ws-sel
		// https://en.cppreference.com/w/cpp/io/manip/ws.html
		std::getline(ss >> std::ws, name, '+');
		std::getline(ss, yearStr, '+');
		std::getline(ss, threatStr);

		// feltételezzük, hogy a fájl helyes formátumú, ezért nem ellenőrizzük a konverziót
		int year = std::stoi(yearStr);
		int threatLevel = std::stoi(threatStr);

		// második sor: Leírás
		std::string desc;
		std::getline(file, desc);

		// harmadik sor: Extra infó
		std::string extraInfo;
		std::getline(file, extraInfo);

		if (type == 'V')
		{
			bool networkSpread = (extraInfo == "Igen");
			Malware *v = new Virus(name, year, threatLevel, desc, networkSpread);
			catalog.addMalware(v);
		}
		else if (type == 'R')
		{
			int ransom = std::stoi(extraInfo);
			Malware *r = new Ransomware(name, year, threatLevel, desc, ransom);
			catalog.addMalware(r);
		}
		else if (type == 'W')
		{
			Malware *w = new Worm(name, year, threatLevel, desc, extraInfo);
			catalog.addMalware(w);
		}
	}

	file.close();

	std::cout << "---- Adding Malware that Already Exists ----" << std::endl;
	try
	{
		catalog.addMalware(new Virus("ILOVEYOU", 2000, 8, "A computer worm that spread through email.", true));
	}
	catch (const std::runtime_error &e)
	{
		std::cout << "Exception successfully caught: " << e.what() << std::endl;
	}

	std::cout << "---- Full Catalog ----" << std::endl;
	catalog.printCatalog();

	std::cout << "---- Find by Name: WannaCry ----" << std::endl;
	Malware *wannacry = catalog.findByName("WannaCry");
	std::cout << *wannacry << std::endl;

	std::cout << "---- Ransomware List ----" << std::endl;
	std::vector<Malware *> ransomwareList = catalog.findByType("ransomware");
	for (Malware *m : ransomwareList)
	{
		std::cout << *m << std::endl;
	}
	std::cout << "---- Sorted by Threat Level Descending ----" << std::endl;

	auto sortedCatalog = catalog.sortByThreatLevelDesc();
	for (const auto &[name, malware] : sortedCatalog)
	{
		std::cout << *malware << std::endl;
	}

	return 0;
}